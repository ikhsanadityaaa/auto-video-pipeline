name: Auto Video Pipeline

# Jadwal Cron untuk Dua Kali Sehari
on:
  schedule:
    # 06:00 WIB (Cron: 0 23 * * *)
    - cron: '0 23 * * *'
    # 16:00 WIB (Cron: 0 9 * * *)
    - cron: '0 9 * * *'
    
  # Konfigurasi Run Manual (Workflow Dispatch)
  workflow_dispatch:
    inputs:
      mode:
        description: 'Pilih mode yang akan dijalankan secara manual.'
        required: true
        default: 'aktual'
        type: choice
        options:
          - aktual
          - masa_lalu

env:
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  
  # ===============================================
  # JOB UTAMA: PENENTU (Dipisah berdasarkan Input/Jadwal)
  # ===============================================
  run_pipeline:
    runs-on: ubuntu-latest
    
    # Kondisi: Jika dijalankan manual, jalankan job hanya jika mode cocok.
    # Jika dijalankan oleh jadwal (cron), job akan selalu berjalan.
    if: |
      github.event_name != 'workflow_dispatch' || 
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'aktual' && (github.event.schedule == '0 23 * * *' || github.event_name == 'workflow_dispatch')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.mode == 'masa_lalu' && (github.event.schedule == '0 9 * * *' || github.event_name == 'workflow_dispatch'))


    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ‚öôÔ∏è Install Dependencies & Upgrade Gemini
        run: |
          pip install --upgrade pip
          pip install --upgrade google-generativeai
          pip install feedparser

      # --- TENTUKAN MODE BERDASARKAN CRON/INPUT MANUAL ---
      - name: üìù Set Pipeline Mode
        id: set_mode
        run: |
          # Logika untuk menentukan mode (aktual/masa_lalu)
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Gunakan input manual
            MODE="${{ github.event.inputs.mode }}"
          elif [ "${{ github.event.schedule }}" == "0 23 * * *" ]; then
            # Jika jadwal 06:00 WIB
            MODE="aktual"
          elif [ "${{ github.event.schedule }}" == "0 9 * * *" ]; then
            # Jika jadwal 16:00 WIB
            MODE="masa_lalu"
          else
            echo "Error: Mode tidak terdefinisi"
            exit 1
          fi
          echo "mode=$MODE" >> $GITHUB_OUTPUT
          echo "topic_file=topic_$MODE.json" >> $GITHUB_OUTPUT
          echo "script_file=script_$MODE.json" >> $GITHUB_OUTPUT

      # 1. TENTUKAN TOPIK (Fetch News)
      - name: üîç Fetch Topic Query (${{ steps.set_mode.outputs.mode }})
        run: python scripts/fetch_news.py --mode ${{ steps.set_mode.outputs.mode }} --keywords-file config/keywords.txt --out ${{ steps.set_mode.outputs.topic_file }}
        
      # 2. GENERATE SCRIPT dengan Gemini
      - name: ‚úçÔ∏è Generate Script & Keywords (Gemini)
        run: python scripts/generate_script.py --input ${{ steps.set_mode.outputs.topic_file }} --output ${{ steps.set_mode.outputs.script_file }}

      # 3. LANJUTAN: UPLOAD ARTIFACTS
      - name: üíæ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: output-${{ steps.set_mode.outputs.mode }}-${{ github.run_number }}
          path: |
            ${{ steps.set_mode.outputs.topic_file }}
            ${{ steps.set_mode.outputs.script_file }} 
            data/news_history.json
          retention-days: 7
