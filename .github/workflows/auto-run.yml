name: Auto Video Pipeline

# Jadwal Cron untuk Dua Kali Sehari
on:
  schedule:
    # 06:00 WIB (Cron: 0 23 * * *)
    # Cron berjalan berdasarkan UTC. 0 UTC = 7:00 WIB. 23 UTC = 6:00 WIB.
    - cron: '0 23 * * *'
    # 16:00 WIB (Cron: 0 9 * * *)
    # 9 UTC = 16:00 WIB.
    - cron: '0 9 * * *'
  # Memungkinkan untuk dijalankan secara manual dari UI GitHub
  workflow_dispatch:

env:
  # Definisikan API Key di level workflow
  # Pastikan Anda sudah menyimpan kunci API Gemini di GitHub Secrets dengan nama GEMINI_API_KEY
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

jobs:
  
  # ===============================================
  # JOB 1: VIDEO AKTUAL (06:00 WIB)
  # ===============================================
  video_aktual:
    # Job ini akan dijalankan pada 23:00 UTC (06:00 WIB) dan saat manual dispatch
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 23 * * *'
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4

      - name: üêç Setup Python Environment
        uses: actions/setup-python@v4
        with:
          # Python 3.10 sudah cukup
          python-version: '3.10'

      - name: ‚öôÔ∏è Install Dependencies & Upgrade Gemini
        run: |
          pip install --upgrade pip
          # Penting: Upgrade google-generativeai untuk fitur structured output
          pip install --upgrade google-generativeai
          pip install feedparser

      # 1. TENTUKAN TOPIK (MODE AKTUAL)
      - name: üîç Fetch Topic Query (AKTUAL)
        # --mode aktual akan dijalankan. Outputnya adalah topic_aktual.json
        run: python scripts/fetch_news.py --mode aktual --keywords-file config/keywords.txt --out topic_aktual.json
        
      # 2. GENERATE SCRIPT dengan Gemini
      - name: ‚úçÔ∏è Generate Script & Keywords (Gemini)
        # Menggunakan skrip generate_script.py, output tunggal: script_aktual.json
        run: python scripts/generate_script.py --input topic_aktual.json --output script_aktual.json

      # TODO: Tambahkan langkah 3 (Pencarian Gambar) dan langkah 4 (Video Rendering) di sini!
      
      - name: üíæ Upload Artifacts (Aktual)
        uses: actions/upload-artifact@v4
        with:
          name: output-aktual-${{ github.run_number }}
          path: |
            topic_aktual.json
            script_aktual.json # Berisi script, keywords faktual/ilustratif
            data/news_history.json
          retention-days: 7

  ---
  
  # ===============================================
  # JOB 2: VIDEO MASA LALU (16:00 WIB)
  # ===============================================
  video_masa_lalu:
    # Job ini akan dijalankan pada 09:00 UTC (16:00 WIB) dan saat manual dispatch
    if: github.event_name == 'workflow_dispatch' || github.event.schedule == '0 9 * * *'
    runs-on: ubuntu-latest
    
    steps:
      - name: üì¶ Checkout Repository
        uses: actions/checkout@v4
      - name: üêç Setup Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ‚öôÔ∏è Install Dependencies & Upgrade Gemini
        run: |
          pip install --upgrade pip
          pip install --upgrade google-generativeai
          pip install feedparser

      # 1. TENTUKAN TOPIK (MODE MASA LALU)
      - name: üîç Fetch Topic Query (MASA_LALU)
        # --mode masa_lalu akan dijalankan. Outputnya adalah topic_past.json
        run: python scripts/fetch_news.py --mode masa_lalu --keywords-file config/keywords.txt --out topic_past.json
        
      # 2. GENERATE SCRIPT dengan Gemini
      - name: ‚úçÔ∏è Generate Script & Keywords (Gemini)
        # Menggunakan skrip generate_script.py, output tunggal: script_past.json
        run: python scripts/generate_script.py --input topic_past.json --output script_past.json

      # TODO: Tambahkan langkah 3 (Pencarian Gambar) dan langkah 4 (Video Rendering) di sini!

      - name: üíæ Upload Artifacts (Masa Lalu)
        uses: actions/upload-artifact@v4
        with:
          name: output-masa-lalu-${{ github.run_number }}
          path: |
            topic_past.json
            script_past.json 
            data/news_history.json
          retention-days: 7
